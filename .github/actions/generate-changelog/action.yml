name: 'ğŸ“‹ Generate Changelog'
description: 'Generate changelog from private repository commits'

inputs:
  app-directory:
    description: 'Directory containing the private repository'
    required: false
    default: 'app'
  version:
    description: 'Version string for the changelog'
    required: true
  commit-count:
    description: 'Number of commits to show per branch'
    required: false
    default: '10'
  branches:
    description: 'Comma-separated list of branches to include'
    required: false
    default: 'dev,main'

outputs:
  changelog:
    description: 'Generated changelog content'
    value: ${{ steps.changelog.outputs.changelog }}

runs:
  using: composite
  steps:
    - name: ğŸ“‹ Generate changelog
      id: changelog
      shell: bash
      run: |
        echo "Generating changelog..."

        # è¿›å…¥ç§æœ‰ä»“åº“ç›®å½•
        cd ${{ inputs.app-directory }}/

        # ç¡®ä¿è·å–æœ€æ–°çš„ç§æœ‰ä»“åº“ä¿¡æ¯
        git fetch --all

        # è·å–å½“å‰ç§æœ‰ä»“åº“çš„æœ€æ–°æäº¤ä¿¡æ¯
        CURRENT_COMMIT=$(git rev-parse HEAD)
        CURRENT_COMMIT_SHORT=$(git rev-parse --short HEAD)
        CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

        # è·å–è§¦å‘ä»“åº“çš„ä¿¡æ¯
        TRIGGER_COMMIT="${{ github.sha }}"
        TRIGGER_COMMIT_SHORT="${TRIGGER_COMMIT:0:7}"

        echo "Current private repo HEAD: $CURRENT_COMMIT"
        echo "Current private repo branch: $CURRENT_BRANCH"

        # è·å–è¿œç¨‹ä»“åº“ URL æ¥æ„å»ºæäº¤é“¾æ¥
        REMOTE_URL=$(git remote get-url origin)
        # æå– owner/repo æ ¼å¼
        if [[ $REMOTE_URL == *"github.com"* ]]; then
          REPO_PATH=$(echo $REMOTE_URL | sed 's|.*github.com[/:]\([^/]*\/[^/]*\).*|\1|' | sed 's|\.git$||')
          GITHUB_BASE_URL="https://github.com/${REPO_PATH}"
        else
          GITHUB_BASE_URL=""
        fi

        echo "Repository path: $REPO_PATH"
        echo "GitHub base URL: $GITHUB_BASE_URL"

        # è·å–é…ç½®çš„åˆ†æ”¯åˆ—è¡¨å’Œæäº¤æ•°é‡
        COMMIT_COUNT="${{ inputs.commit-count }}"
        BRANCH_LIST="${{ inputs.branches }}"

        echo "Fetching commits from branches: $BRANCH_LIST"
        echo "Commits per branch: $COMMIT_COUNT"

        # åˆ†åˆ«è·å–æ¯ä¸ªåˆ†æ”¯çš„æäº¤
        COMMITS_SECTION=""
        IFS=',' read -ra BRANCHES <<< "$BRANCH_LIST"

        for branch in "${BRANCHES[@]}"; do
          # å»é™¤ç©ºæ ¼
          branch=$(echo "$branch" | xargs)
          echo "Processing branch: $branch"
          
          # æ£€æŸ¥åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if git show-ref --verify --quiet refs/remotes/origin/$branch; then
            echo "Branch $branch exists, fetching commits..."
            
            # è·å–è¯¥åˆ†æ”¯çš„æäº¤ï¼Œå¸¦è¶…é“¾æ¥
            if [[ -n "$GITHUB_BASE_URL" ]]; then
              # å¸¦è¶…é“¾æ¥çš„ç‰ˆæœ¬
              BRANCH_COMMITS=$(git log origin/$branch --oneline -$COMMIT_COUNT --pretty=format:"  - %s ([%h]($GITHUB_BASE_URL/commit/%H))" 2>/dev/null || echo "  - æ— æäº¤è®°å½•")
            else
              # æ— é“¾æ¥çš„å¤‡ç”¨ç‰ˆæœ¬
              BRANCH_COMMITS=$(git log origin/$branch --oneline -$COMMIT_COUNT --pretty=format:"  - %s (%h)" 2>/dev/null || echo "  - æ— æäº¤è®°å½•")
            fi
            
            if [[ -n "$BRANCH_COMMITS" ]]; then
              # æ„å»ºåˆ†æ”¯æäº¤ä¿¡æ¯
              BRANCH_SECTION="#### ğŸ“‹ \`${branch}\` åˆ†æ”¯æœ€æ–°æäº¤"$'\n'"${BRANCH_COMMITS}"$'\n'
              COMMITS_SECTION="${COMMITS_SECTION}${BRANCH_SECTION}"
            else
              # æ— æäº¤è®°å½•
              BRANCH_SECTION="#### ğŸ“‹ \`${branch}\` åˆ†æ”¯æœ€æ–°æäº¤"$'\n'"  - æ— æäº¤è®°å½•"$'\n'
              COMMITS_SECTION="${COMMITS_SECTION}${BRANCH_SECTION}"
            fi
          else
            echo "Branch $branch not found, skipping..."
            # åˆ†æ”¯ä¸å­˜åœ¨
            BRANCH_SECTION="#### ğŸ“‹ \`${branch}\` åˆ†æ”¯æœ€æ–°æäº¤"$'\n'"  - åˆ†æ”¯ä¸å­˜åœ¨"$'\n'
            COMMITS_SECTION="${COMMITS_SECTION}${BRANCH_SECTION}"
          fi
        done

        # å¦‚æœæ²¡æœ‰è·å–åˆ°ä»»ä½•æäº¤ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤ä¿¡æ¯
        if [[ -z "$COMMITS_SECTION" ]]; then
          COMMITS_SECTION="#### ğŸ“‹ å½“å‰åˆ†æ”¯æœ€æ–°æäº¤"$'\n'"  - æ„å»ºå’Œå‘å¸ƒåº”ç”¨ç¨‹åº ($CURRENT_COMMIT_SHORT)"
        fi

        echo "Found commits from private repo branches:"
        echo "$COMMITS_SECTION"

        # è¿”å›æ ¹ç›®å½•
        cd ..

        # è·å–è§¦å‘ä»“åº“çš„æäº¤ä¿¡æ¯
        TRIGGER_INFO_SECTION=""
        if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
          # æ¥è‡ª repository dispatch çš„æ„å»º
          TRIGGER_INFO_SECTION="
        ### ğŸ”” è§¦å‘ä¿¡æ¯
        - **è§¦å‘ä»“åº“**: \`${{ github.event.client_payload.source_repository }}\`
        - **è§¦å‘åˆ†æ”¯**: \`${{ github.event.client_payload.source_branch }}\`
        - **è§¦å‘æäº¤**: \`${{ github.event.client_payload.source_commit }}\`
        - **è§¦å‘è€…**: \`${{ github.event.client_payload.pusher }}\`
        - **æäº¤æ¶ˆæ¯**: ${{ github.event.client_payload.commit_message }}"
        else
          # æ™®é€šçš„ push æˆ– workflow_dispatch
          TRIGGER_INFO_SECTION="
        ### ğŸ”” æ„å»ºè§¦å‘ä¿¡æ¯
        - **è§¦å‘ä»“åº“**: \`${{ github.repository }}\`
        - **è§¦å‘åˆ†æ”¯**: \`${{ github.ref_name }}\`
        - **è§¦å‘æäº¤**: \`${TRIGGER_COMMIT}\`
        - **è§¦å‘äº‹ä»¶**: \`${{ github.event_name }}\`"
          
          # å¦‚æœæ˜¯ push äº‹ä»¶ï¼Œæ·»åŠ æäº¤ä¿¡æ¯
          if [[ "${{ github.event_name }}" == "push" ]]; then
            TRIGGER_INFO_SECTION="${TRIGGER_INFO_SECTION}
        - **æäº¤æ¶ˆæ¯**: \`${{ github.event.head_commit.message }}\`
        - **æäº¤è€…**: \`${{ github.event.head_commit.author.name }}\`"
          fi
        fi

        # ç”Ÿæˆå˜æ›´æ—¥å¿—
        CHANGELOG="## ğŸ‰ ç‰ˆæœ¬ ${{ inputs.version }}

        ### ğŸ“… å‘å¸ƒä¿¡æ¯
        - **å‘å¸ƒæ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
        - **ç§æœ‰ä»“åº“æäº¤**: \`${CURRENT_COMMIT}\`
        - **ç§æœ‰ä»“åº“åˆ†æ”¯**: \`${CURRENT_BRANCH}\`
        ${TRIGGER_INFO_SECTION}

        ### ğŸ“ ç§æœ‰ä»“åº“æœ€æ–°æäº¤
        ${COMMITS_SECTION}

        ### ğŸ“¦ ä¸‹è½½è¯´æ˜
        - **æ–‡ä»¶æ ¼å¼**: æ‰€æœ‰æ„å»ºäº§ç‰©éƒ½ç»è¿‡å¯†ç åŠ å¯†çš„ 7z å‹ç¼©åŒ…ä¿æŠ¤
        - **è§£å‹å¯†ç **: è¯·è”ç³»ç®¡ç†å‘˜è·å–è§£å‹å¯†ç 
        - **macOS**: ä¸‹è½½ \`app-*-darwin-x64.7z\`ï¼Œè§£å‹åæ·»åŠ æ‰§è¡Œæƒé™: \`chmod +x app-*-darwin-x64 && ./app-*-darwin-x64\`
        - **Linux**: ä¸‹è½½ \`app-*-linux-x64.7z\`ï¼Œè§£å‹åæ·»åŠ æ‰§è¡Œæƒé™: \`chmod +x app-*-linux-x64 && ./app-*-linux-x64\`

        ### ğŸ”“ è§£å‹è¯´æ˜
        1. ä¸‹è½½å¯¹åº”å¹³å°çš„ .7z æ–‡ä»¶
        2. ä½¿ç”¨ 7-Zip æˆ–å…¶ä»–æ”¯æŒ 7z æ ¼å¼çš„è§£å‹å·¥å…·
        3. è¾“å…¥è§£å‹å¯†ç ï¼ˆè¯·è”ç³»ç®¡ç†å‘˜ï¼‰
        4. è§£å‹åæŒ‰å¹³å°è¯´æ˜è¿è¡Œ

        ### ğŸ”§ æŠ€æœ¯æ ˆ
        - **è¿è¡Œæ—¶**: Bun
        - **æ¡†æ¶**: ElysiaJS
        - **æ•°æ®åº“**: Drizzle ORM + PostgreSQL
        - **æ¶æ„**: DDD + CQRS

        ### âš ï¸ macOS ç”¨æˆ·æ³¨æ„
        1. ä¸‹è½½å¯æ‰§è¡Œæ–‡ä»¶
        2. æ‰“å¼€ç»ˆç«¯ï¼Œè¿›å…¥ä¸‹è½½ç›®å½•
        3. æ‰§è¡Œ \`chmod +x app-*-darwin-x64 && ./app-*-darwin-x64\`
        4. å¦‚æœä»æç¤ºå®‰å…¨é—®é¢˜ï¼Œè¯·åœ¨ç³»ç»Ÿåå¥½è®¾ç½® â†’ å®‰å…¨æ€§ä¸éšç§ â†’ é€šç”¨ä¸­ç‚¹å‡»\"ä»è¦æ‰“å¼€\"
        5. æˆ–è€…è¿è¡Œ: \`xattr -d com.apple.quarantine ./app-*-darwin-x64\` ç„¶åå†æ‰§è¡Œ"

        # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡ï¼ˆå¤„ç†å¤šè¡Œï¼‰
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

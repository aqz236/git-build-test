name: 'ğŸ—ï¸ Build Application'
description: 'Build the application with Bun and prepare executable'

inputs:
  app-directory:
    description: 'Directory containing the application source'
    required: false
    default: 'app'
  executable-name:
    description: 'Name of the output executable'
    required: false
    default: 'app'
  platform:
    description: 'Target platform (macos-latest, ubuntu-latest)'
    required: true

runs:
  using: composite
  steps:
    - name: ğŸŸ¢ Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: ğŸ“¦ Install dependencies
      shell: bash
      run: |
        cd ${{ inputs.app-directory }}/
        bun install --frozen-lockfile

    - name: ğŸ” Lint code
      shell: bash
      run: |
        cd ${{ inputs.app-directory }}/
        bun run lint

    - name: ğŸ—ï¸ Build application
      shell: bash
      run: |
        cd ${{ inputs.app-directory }}/
        mkdir -p dist
        bun build src/index.ts --compile --outfile dist/${{ inputs.executable-name }}

    - name: ğŸ macOS post-build processing
      if: inputs.platform == 'macos-latest'
      shell: bash
      run: |
        cd ${{ inputs.app-directory }}/
        # ç§»é™¤æ‰€æœ‰æ‰©å±•å±æ€§ï¼ŒåŒ…æ‹¬éš”ç¦»å±æ€§
        xattr -c dist/${{ inputs.executable-name }} 2>/dev/null || true
        # ç¡®ä¿æ²¡æœ‰ä»»ä½•éš”ç¦»æ ‡è®°
        xattr -d com.apple.quarantine dist/${{ inputs.executable-name }} 2>/dev/null || true
        # ç§»é™¤æ‰€æœ‰å¯èƒ½çš„å±æ€§
        xattr -cr dist/${{ inputs.executable-name }} 2>/dev/null || true

        # è®¾ç½®å¯æ‰§è¡Œæƒé™
        chmod +x dist/${{ inputs.executable-name }}

        # Ad hoc ä»£ç ç­¾å - è¿™æ˜¯å…³é”®æ­¥éª¤
        echo "ğŸ” Performing ad hoc code signing..."
        codesign --force --deep --sign - dist/${{ inputs.executable-name }}

        # éªŒè¯ç­¾å
        echo "âœ… Verifying code signature..."
        codesign --verify --verbose dist/${{ inputs.executable-name }}

        # æ˜¾ç¤ºç­¾åä¿¡æ¯
        echo "ğŸ“‹ Code signature info:"
        codesign --display --verbose dist/${{ inputs.executable-name }}

        # æ£€æŸ¥ç­¾åçŠ¶æ€
        echo "ğŸ” Checking signature status:"
        codesign --test-requirement="=designated => anchor apple generic" dist/${{ inputs.executable-name }} || echo "Note: This is expected for ad hoc signatures"

        # éªŒè¯Gatekeeperå…¼å®¹æ€§
        echo "ğŸšª Testing Gatekeeper compatibility:"
        spctl --assess --type execute dist/${{ inputs.executable-name }} || echo "Note: Ad hoc signatures are not Gatekeeper-approved but should work"

        # éªŒè¯æ–‡ä»¶ç±»å‹
        file dist/${{ inputs.executable-name }}

        # æœ€ç»ˆéªŒè¯æ²¡æœ‰æ‰©å±•å±æ€§
        echo "ğŸ” Final extended attributes check:"
        xattr -l dist/${{ inputs.executable-name }} || echo "No extended attributes found (good!)"

    - name: ğŸ§ Linux post-build processing
      if: inputs.platform == 'ubuntu-latest'
      shell: bash
      run: |
        cd ${{ inputs.app-directory }}/
        # ç¡®ä¿å¯æ‰§è¡Œæƒé™
        chmod +x dist/${{ inputs.executable-name }}
        # éªŒè¯æ–‡ä»¶
        file dist/${{ inputs.executable-name }}

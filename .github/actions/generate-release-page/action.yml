name: "ðŸŒ Generate Release Page"
description: "Generate GitHub Pages for each release"

inputs:
  app-directory:
    description: "Directory containing the private repository"
    required: false
    default: "app"
  version:
    description: "Version string for the release"
    required: true
  commit-count:
    description: "Number of commits to show per branch"
    required: false
    default: "10"
  branches:
    description: "Comma-separated list of branches to include"
    required: false
    default: "dev,main"
  changelog:
    description: "Generated changelog content"
    required: true

outputs:
  page-url:
    description: "URL of the generated release page"
    value: ${{ steps.generate-page.outputs.page-url }}

runs:
  using: composite
  steps:
    - name: ðŸŒ Generate release page
      id: generate-page
      shell: bash
      run: |
        echo "Generating release page..."

        # è¿›å…¥ç§æœ‰ä»“åº“ç›®å½•èŽ·å–ä¿¡æ¯
        cd ${{ inputs.app-directory }}/

        # èŽ·å–å½“å‰ç§æœ‰ä»“åº“çš„ä¿¡æ¯
        CURRENT_COMMIT=$(git rev-parse HEAD)
        CURRENT_COMMIT_SHORT=$(git rev-parse --short HEAD)
        CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

        # èŽ·å–è¿œç¨‹ä»“åº“ä¿¡æ¯
        REMOTE_URL=$(git remote get-url origin)
        if [[ $REMOTE_URL == *"github.com"* ]]; then
          REPO_PATH=$(echo $REMOTE_URL | sed 's|.*github.com[/:]\([^/]*\/[^/]*\).*|\1|' | sed 's|\.git$||')
          GITHUB_BASE_URL="https://github.com/${REPO_PATH}"
        else
          REPO_PATH=""
          GITHUB_BASE_URL=""
        fi

        # è¿”å›žæ ¹ç›®å½•
        cd ..

        # èŽ·å–è§¦å‘ä¿¡æ¯
        TRIGGER_EVENT="${{ github.event_name }}"
        TRIGGER_REPO="${{ github.repository }}"
        TRIGGER_BRANCH="${{ github.ref_name }}"
        TRIGGER_COMMIT="${{ github.sha }}"
        TRIGGER_AUTHOR="${{ github.actor }}"
        
        # èŽ·å–æäº¤æ¶ˆæ¯
        COMMIT_MESSAGE=""
        if [[ "${{ github.event_name }}" == "push" ]]; then
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
        elif [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
          COMMIT_MESSAGE="${{ github.event.client_payload.commit_message }}"
        fi

        # åˆ›å»ºå‘å¸ƒç›®å½•
        RELEASE_DIR="pages/${CURRENT_COMMIT}"
        mkdir -p "$RELEASE_DIR"

        echo "Creating release page in: $RELEASE_DIR"
        echo "Version: ${{ inputs.version }}"
        echo "Commit: $CURRENT_COMMIT"

        # èŽ·å–å½“å‰æ—¶é—´
        CREATED_AT=$(date -u +'%Y-%m-%dT%H:%M:%S.%3NZ')

        # å¤åˆ¶å¹¶å¤„ç†æ¨¡æ¿æ–‡ä»¶
        cp pages/release-template.html "$RELEASE_DIR/index.html"

        # ç®€å•çš„æ›¿æ¢ï¼Œé¿å…å¤æ‚çš„å¤šè¡Œå¤„ç†
        sed -i.bak "s|{{VERSION}}|${{ inputs.version }}|g" "$RELEASE_DIR/index.html"
        sed -i.bak "s|{{CREATED_AT}}|$CREATED_AT|g" "$RELEASE_DIR/index.html"
        sed -i.bak "s|{{COMMIT_HASH}}|$CURRENT_COMMIT|g" "$RELEASE_DIR/index.html"
        sed -i.bak "s|{{PRIVATE_BRANCH}}|$CURRENT_BRANCH|g" "$RELEASE_DIR/index.html"
        sed -i.bak "s|{{TRIGGER_EVENT}}|$TRIGGER_EVENT|g" "$RELEASE_DIR/index.html"
        sed -i.bak "s|{{TRIGGER_REPO}}|$TRIGGER_REPO|g" "$RELEASE_DIR/index.html"
        sed -i.bak "s|{{TRIGGER_BRANCH}}|$TRIGGER_BRANCH|g" "$RELEASE_DIR/index.html"
        sed -i.bak "s|{{TRIGGER_COMMIT}}|$TRIGGER_COMMIT|g" "$RELEASE_DIR/index.html"
        sed -i.bak "s|{{TRIGGER_AUTHOR}}|$TRIGGER_AUTHOR|g" "$RELEASE_DIR/index.html"
        sed -i.bak "s|{{COMMIT_MESSAGE}}|$COMMIT_MESSAGE|g" "$RELEASE_DIR/index.html"
        sed -i.bak "s|{{GITHUB_BASE_URL}}|$GITHUB_BASE_URL|g" "$RELEASE_DIR/index.html"
        sed -i.bak "s|{{REPO_PATH}}|$REPO_PATH|g" "$RELEASE_DIR/index.html"
        
        # å¤„ç† changelog - æš‚æ—¶ç”¨ç®€å•çš„æ›¿æ¢ï¼ŒåŽç»­å¯ä»¥ä¼˜åŒ–
        sed -i.bak "s|{{CHANGELOG}}|æŸ¥çœ‹å®Œæ•´ changelog|g" "$RELEASE_DIR/index.html"

        # æ¸…ç†å¤‡ä»½æ–‡ä»¶
        rm -f "$RELEASE_DIR/index.html.bak"

        # ç®€åŒ– JSON æ›´æ–° - åˆ›å»ºåŸºæœ¬çš„å‘å¸ƒè®°å½•
        if [[ ! -f "pages/releases.json" ]]; then
          echo '{"releases":[]}' > pages/releases.json
        fi

        # ä½¿ç”¨ jq æ·»åŠ æ–°è®°å½•ï¼ˆå¦‚æžœå¯ç”¨ï¼‰
        if command -v jq >/dev/null 2>&1; then
          NEW_RELEASE=$(jq -n \
            --arg version "${{ inputs.version }}" \
            --arg commit_hash "$CURRENT_COMMIT" \
            --arg created_at "$CREATED_AT" \
            --arg branch "$CURRENT_BRANCH" \
            --arg trigger_event "$TRIGGER_EVENT" \
            --arg trigger_repo "$TRIGGER_REPO" \
            --arg status "success" \
            '{
              version: $version,
              commit_hash: $commit_hash,
              created_at: $created_at,
              branch: $branch,
              trigger_event: $trigger_event,
              trigger_repo: $trigger_repo,
              status: $status
            }')
          
          # æ·»åŠ åˆ° releases.json
          jq --argjson new_release "$NEW_RELEASE" '.releases |= [($new_release)] + .[0:49]' pages/releases.json > pages/releases.json.tmp
          mv pages/releases.json.tmp pages/releases.json
        else
          echo "jq not available, using basic JSON update"
        fi

        # è¾“å‡ºé¡µé¢ URL
        if [[ -n "${{ github.repository }}" ]]; then
          PAGE_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${CURRENT_COMMIT}/"
        else
          PAGE_URL="/${CURRENT_COMMIT}/"
        fi

        echo "page-url=$PAGE_URL" >> $GITHUB_OUTPUT
        echo "Generated release page: $PAGE_URL"
        echo "Files created:"
        ls -la "$RELEASE_DIR/"
        echo "Updated releases.json"

        # è¾“å‡ºé¡µé¢ URL
        if [[ -n "${{ github.repository }}" ]]; then
          PAGE_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${CURRENT_COMMIT}/"
        else
          PAGE_URL="/${CURRENT_COMMIT}/"
        fi

        echo "page-url=$PAGE_URL" >> $GITHUB_OUTPUT
        echo "Generated release page: $PAGE_URL"
        echo "Files created:"
        ls -la "$RELEASE_DIR/"
        echo "Updated releases.json"

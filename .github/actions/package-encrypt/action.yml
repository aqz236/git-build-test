name: 'ğŸ“¦ Package and Encrypt'
description: 'Package the built executable and encrypt with 7z'

inputs:
  app-directory:
    description: 'Directory containing the built application'
    required: false
    default: 'app'
  executable-name:
    description: 'Name of the executable file'
    required: false
    default: 'app'
  version:
    description: 'Version string for the package'
    required: true
  artifact-name:
    description: 'Artifact name suffix (e.g., darwin-x64, linux-x64)'
    required: true
  encryption-password:
    description: 'Password for 7z encryption'
    required: true
  platform:
    description: 'Target platform (macos-latest, ubuntu-latest)'
    required: true

outputs:
  package-name:
    description: 'Name of the created package'
    value: ${{ steps.package.outputs.package-name }}

runs:
  using: composite
  steps:
    - name: ğŸ“¦ Prepare release file
      id: package
      shell: bash
      run: |
        cd ${{ inputs.app-directory }}/
        # é‡å‘½åå¯æ‰§è¡Œæ–‡ä»¶ï¼ŒåŒ…å«å¹³å°ä¿¡æ¯
        FINAL_NAME="app-${{ inputs.version }}-${{ inputs.artifact-name }}"
        
        if [[ "${{ inputs.platform }}" == "macos-latest" ]]; then
          # macOS: åœ¨é‡å‘½åå‰å†æ¬¡ç¡®ä¿æ–‡ä»¶å¹²å‡€
          xattr -c dist/${{ inputs.executable-name }} 2>/dev/null || true
          mv dist/${{ inputs.executable-name }} "../${FINAL_NAME}"
        else
          # Linux
          mv dist/${{ inputs.executable-name }} "../${FINAL_NAME}"
        fi

        cd ..
        # éªŒè¯æ–‡ä»¶
        ls -la "${FINAL_NAME}"
        file "${FINAL_NAME}"
        
        echo "package-name=${FINAL_NAME}" >> $GITHUB_OUTPUT

    - name: ğŸ”’ Compress and encrypt build artifact
      shell: bash
      run: |
        # å®‰è£… 7z
        if [[ "${{ inputs.platform }}" == "ubuntu-latest" ]]; then
          sudo apt-get update && sudo apt-get install -y p7zip-full
        fi

        # macOS å·²ç»é¢„è£…äº† 7z

        # åˆ›å»ºåŠ å¯†çš„ 7z å‹ç¼©åŒ…
        FILENAME="app-${{ inputs.version }}-${{ inputs.artifact-name }}"
        ARCHIVE_NAME="${FILENAME}.7z"

        echo "ğŸ”’ Creating encrypted archive: ${ARCHIVE_NAME}"
        7z a -p"${{ inputs.encryption-password }}" -mhe=on "${ARCHIVE_NAME}" "${FILENAME}"

        # éªŒè¯å‹ç¼©åŒ…ï¼ˆä¸æ˜¾ç¤ºå†…å®¹ï¼Œé¿å…å¯†ç äº¤äº’ï¼‰
        echo "ğŸ“‹ Archive info:"
        ls -la "${ARCHIVE_NAME}"
        echo "âœ… Archive created successfully"

        # åˆ é™¤åŸå§‹æ–‡ä»¶ï¼ˆåªä¿ç•™åŠ å¯†å‹ç¼©åŒ…ï¼‰
        rm "${FILENAME}"

        echo "âœ… Encrypted archive created successfully: ${ARCHIVE_NAME}"

name: ðŸš€ Create Release

# ðŸ“Š é…ç½®å‚æ•°
env:
  CHANGELOG_COMMIT_COUNT: 10 # æ¯ä¸ªåˆ†æ”¯æ˜¾ç¤ºçš„æäº¤æ•°é‡
  CHANGELOG_BRANCHES: "dev,main" # è¦æ˜¾ç¤ºçš„åˆ†æ”¯åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰

on:
  workflow_run:
    workflows: ["ðŸ”¨ Build Application"]
    types: [completed]
    branches: [main, dev]
  push:
    tags: ["v*"]
  workflow_dispatch:
  workflow_call:

permissions:
  contents: write
  actions: read

jobs:
  release:
    name: ðŸš€ Create Release
    runs-on: ubuntu-latest
    environment: elysiajs-rapid
    if: |
      (github.event.workflow_run.conclusion == 'success' && 
       (github.event.workflow_run.head_branch == 'main' || 
        github.event.workflow_run.head_branch == 'dev')) ||
      startsWith(github.ref, 'refs/tags/') ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¥ Clone private repository
        uses: ./.github/actions/clone-private-repo
        with:
          repository-url: ${{ secrets.REPOSITORY_URL }}
          github-token: ${{ secrets.SELF_GITHUB_SECRETS }}

      - name: ðŸ·ï¸ Generate version
        id: version
        uses: ./.github/actions/generate-version

      - name: ðŸ“‹ Generate changelog
        id: changelog
        uses: ./.github/actions/generate-changelog
        with:
          version: ${{ steps.version.outputs.version }}
          commit-count: ${{ env.CHANGELOG_COMMIT_COUNT }}
          branches: ${{ env.CHANGELOG_BRANCHES }}

      - name: ðŸ“¤ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: ðŸ” Debug artifacts structure
        run: |
          echo "=== Artifacts directory structure ==="
          find ./artifacts -type f -ls
          echo "=== Looking for app-* files ==="
          find ./artifacts -name "app-*" -type f
          echo "=== Looking for .7z files ==="
          find ./artifacts -name "*.7z" -type f
          echo "=== All files in artifacts ==="
          ls -la ./artifacts/

      - name: ðŸ“ Prepare release assets
        run: |
          mkdir -p release-assets
          # é€’å½’æŸ¥æ‰¾æ‰€æœ‰.7zæ–‡ä»¶ï¼ˆåŠ å¯†åŽ‹ç¼©åŒ…ï¼‰
          find ./artifacts -name "*.7z" -type f | while read file; do
            echo "Found and copying: $file"
            # å¤åˆ¶æ–‡ä»¶ï¼Œä¿æŒåŽŸæ–‡ä»¶åï¼ˆåŽ»æŽ‰è·¯å¾„ï¼‰
            cp "$file" "release-assets/$(basename "$file")"
          done

          echo "=== Final release assets ==="
          ls -la release-assets/

          # ç¡®ä¿è‡³å°‘æœ‰æ–‡ä»¶å­˜åœ¨
          if [ ! "$(ls -A release-assets/)" ]; then
            echo "ERROR: No release assets found!"
            exit 1
          fi

      - name: ðŸ·ï¸ Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "Release ${{ steps.version.outputs.version }}"
          body: ${{ steps.changelog.outputs.changelog }}
          prerelease: ${{ steps.version.outputs.is-prerelease }}
          files: release-assets/*
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¢ Release Summary
        run: |
          echo "## ðŸŽ‰ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Prerelease**: ${{ steps.version.outputs.is-prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Available Downloads:" >> $GITHUB_STEP_SUMMARY
          echo "- macOS: \`app-${{ steps.version.outputs.version }}-darwin-x64.7z\` (åŠ å¯†åŽ‹ç¼©åŒ…)" >> $GITHUB_STEP_SUMMARY
          echo "- Linux: \`app-${{ steps.version.outputs.version }}-linux-x64.7z\` (åŠ å¯†åŽ‹ç¼©åŒ…)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”’ **æ³¨æ„**: æ‰€æœ‰æ–‡ä»¶éƒ½ç»è¿‡å¯†ç ä¿æŠ¤ï¼Œè¯·è”ç³»ç®¡ç†å‘˜èŽ·å–è§£åŽ‹å¯†ç " >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }})" >> $GITHUB_STEP_SUMMARY

name: ğŸš€ NextJS Static Deploy

# ğŸ“Š é…ç½®å‚æ•°
env:
  NODE_VERSION: "20"
  BUN_VERSION: "latest"

on:
  push:
    branches:
      - main
      - dev
  repository_dispatch:
    types: [build]
  workflow_dispatch:
    inputs:
      deploy_branch:
        description: "éƒ¨ç½²åˆ†æ”¯ (main/dev)"
        required: true
        default: "main"
        type: choice
        options:
          - main
          - dev

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: elysiajs-rapid
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # ä½¿ç”¨æ‚¨åŸæœ‰çš„æ–¹å¼å…‹éš†ç§æœ‰ä»“åº“
      - name: ğŸ“¥ Clone private repository
        run: |
          # ä½¿ç”¨æ‚¨åœ¨ elysiajs-rapid ç¯å¢ƒä¸­é…ç½®çš„æ–¹å¼
          REPO_URL="${{ secrets.REPOSITORY_URL }}"
          if [[ $REPO_URL == https://github.com/* ]]; then
            # ä»å®Œæ•´URLä¸­æå– owner/repo
            REPO_PATH=$(echo $REPO_URL | sed 's|https://github.com/||' | sed 's|\.git$||')
          else
            # å·²ç»æ˜¯ owner/repo æ ¼å¼
            REPO_PATH=$REPO_URL
          fi

          echo "Cloning repository: $REPO_PATH"
          git clone https://${{ secrets.SELF_GITHUB_SECRETS }}@github.com/${REPO_PATH}.git app/
          cd app/
          git fetch --all --tags

      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      # è®¾ç½® Bun ç¯å¢ƒ
      - name: ğŸ¥– Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      # å®‰è£…ä¾èµ–
      - name: ğŸ“¦ Install dependencies
        working-directory: ./app
        run: bun install --frozen-lockfile

      # æ„å»º NextJS é™æ€ç«™ç‚¹
      - name: ğŸ”¨ Build NextJS
        working-directory: ./app
        run: |
          echo "Building NextJS application..."
          bun run build

      # å¯¼å‡ºé™æ€æ–‡ä»¶
      - name: ğŸ“¤ Export static files
        working-directory: ./app
        run: |
          echo "Exporting static files..."
          # æ£€æŸ¥æ˜¯å¦æœ‰ out ç›®å½•ï¼ˆé™æ€å¯¼å‡ºï¼‰
          if [ -d "out" ]; then
            echo "Found 'out' directory from static export"
            cp -r out/* ../dist/
          elif [ -d ".next" ]; then
            echo "Found '.next' directory, copying build output"
            mkdir -p ../dist
            cp -r .next/static ../dist/_next/
            # å¦‚æœæœ‰å…¶ä»–é™æ€èµ„æº
            if [ -d "public" ]; then
              cp -r public/* ../dist/
            fi
          else
            echo "No build output found"
            exit 1
          fi

      # é…ç½® GitHub Pages
      - name: ğŸŒ Setup Pages
        uses: actions/configure-pages@v4

      # ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ğŸ“¤ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

      # éƒ¨ç½²åˆ° GitHub Pages
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # ç¡®å®šç‰ˆæœ¬å·
      - name: ğŸ·ï¸ Determine version
        id: version
        uses: ./.github/actions/generate-version
        with:
          app-directory: app

      # ç”Ÿæˆ changelog
      - name: ğŸ“‹ Generate changelog
        id: changelog
        uses: ./.github/actions/generate-changelog
        with:
          app-directory: app
          version: ${{ steps.version.outputs.version }}
          commit-count: 10
          branches: "dev,main"

      # åˆ›å»º GitHub Releaseï¼ˆç¡®ä¿æœ‰release assetså¯ä»¥è·å–ï¼‰
      - name: ğŸ·ï¸ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "Release ${{ steps.version.outputs.version }}"
          body: ${{ steps.changelog.outputs.changelog }}
          prerelease: ${{ steps.version.outputs.is-prerelease }}
          draft: false
          files: |
            app-${{ steps.version.outputs.version }}-*.7z
            *.7z
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true # å…è®¸å¤±è´¥ï¼Œå› ä¸ºå¯èƒ½æ²¡æœ‰æ„å»ºäº§ç‰©

      # è¾“å‡ºç»“æœ
      - name: ğŸ“Š Output results
        run: |
          echo "## ğŸ‰ å‘å¸ƒå®Œæˆ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ å˜æ›´æ—¥å¿—é¢„è§ˆ" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.changelog.outputs.changelog }}" | head -20 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # å¯é€‰ï¼šé€šçŸ¥æ­¥éª¤
  notify:
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: always()
    steps:
      - name: ğŸ“¢ Notify completion
        run: |
          if [[ "${{ needs.build-and-deploy.result }}" == "success" ]]; then
            echo "âœ… å‘å¸ƒæˆåŠŸå®Œæˆ"
          else
            echo "âŒ å‘å¸ƒå¤±è´¥"
          fi

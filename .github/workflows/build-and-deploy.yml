name: ğŸš€ Build and Deploy Release Page

on:
  push:
    branches:
      - main
      - dev
  repository_dispatch:
    types: [build]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # è¿™é‡Œå‡è®¾æ‚¨æœ‰ä¸€ä¸ªç§æœ‰ä»“åº“éœ€è¦æ£€å‡º
      # å¦‚æœæ²¡æœ‰ï¼Œå¯ä»¥è·³è¿‡è¿™ä¸€æ­¥
      - name: ğŸ“¥ Checkout private repository
        uses: actions/checkout@v4
        with:
          repository: YOUR_ORG/YOUR_PRIVATE_REPO  # æ›¿æ¢ä¸ºæ‚¨çš„ç§æœ‰ä»“åº“
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}  # éœ€è¦é…ç½®è®¿é—®ç§æœ‰ä»“åº“çš„ token
          path: app
          fetch-depth: 0

      # ç¡®å®šç‰ˆæœ¬å·
      - name: ğŸ·ï¸ Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            VERSION="${{ github.event.client_payload.version || '1.0.0' }}"
          else
            # åŸºäºæ—¶é—´æˆ³ç”Ÿæˆç‰ˆæœ¬å·
            VERSION="1.0.$(date +'%Y%m%d%H%M')"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"

      # ç”Ÿæˆ changelog
      - name: ğŸ“‹ Generate changelog
        id: changelog
        uses: ./.github/actions/generate-changelog
        with:
          app-directory: app
          version: ${{ steps.version.outputs.version }}
          commit-count: 10
          branches: "dev,main"

      # ç”Ÿæˆå‘å¸ƒé¡µé¢
      - name: ğŸŒ Generate release page
        id: release-page
        uses: ./.github/actions/generate-release-page
        with:
          app-directory: app
          version: ${{ steps.version.outputs.version }}
          changelog: ${{ steps.changelog.outputs.changelog }}

      # è®¾ç½® GitHub Pages
      - name: ğŸ”§ Setup Pages
        uses: actions/configure-pages@v4

      # ä¸Šä¼  Pages åˆ¶å“
      - name: ğŸ“¤ Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages/

      # éƒ¨ç½²åˆ° GitHub Pages
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # è¾“å‡ºç»“æœ
      - name: ğŸ“Š Output results
        run: |
          echo "## ğŸ‰ å‘å¸ƒå®Œæˆ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å‘å¸ƒé¡µé¢**: ${{ steps.release-page.outputs.page-url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **éƒ¨ç½²URL**: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ å˜æ›´æ—¥å¿—é¢„è§ˆ" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.changelog.outputs.changelog }}" | head -20 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # å¯é€‰ï¼šé€šçŸ¥æ­¥éª¤
  notify:
    runs-on: ubuntu-latest
    needs: build-and-release
    if: always()
    steps:
      - name: ğŸ“¢ Notify completion
        run: |
          if [[ "${{ needs.build-and-release.result }}" == "success" ]]; then
            echo "âœ… å‘å¸ƒæˆåŠŸå®Œæˆ"
          else
            echo "âŒ å‘å¸ƒå¤±è´¥"
          fi
